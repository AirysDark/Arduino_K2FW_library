STATUS
QUERY_ENDSTOPS
M114
QUERY_ENDSTOPS
nano /mnt/UDISK/printer_data/config/user_macros.cfg
grep -nE "position_max|position_min|mesh_min|mesh_max|max_velocity|max_z_velocity" -n /mnt/UDISK/printer_data/config/printer.cfg
cp -a /etc/nginx /mnt/UDISK/nginx_backup_$(date +%Y%m%d_%H%M%S)
/etc/init.d/nginx reload
/etc/init.d/nginx restart
reboot
restart
restartreboot
RESTART
TEST_OK
mkdir -p /mnt/UDISK/fluidd
# copy Fluidd dist contents into /mnt/UDISK/fluidd (index.html, assets/, etc.)
busybox httpd -f -p 8081 -h /mnt/UDISK/fluidd &
cat > /etc/init.d/fluidd_udisk <<'EOF'
#!/bin/sh /etc/rc.common
START=99
USE_PROCD=1
start_service() {
  procd_open_instance
  procd_set_param command /bin/busybox httpd -f -p 8081 -h /mnt/UDISK/fluidd
  procd_set_param respawn
  procd_close_instance
}
EOF
chmod +x /etc/init.d/fluidd_udisk
/etc/init.d/fluidd_udisk enable
/etc/init.d/fluidd_udisk start
RESTART
REBOOT
sudo nano /rom/usr/share/moonraker/moonraker.conf
nano /rom/usr/share/moonraker/moonraker.conf
cd /rom/usr/share/moonraker/moonraker.conf
cd /rom/usr/share/moonraker/
ls
moonraker.conf
vi moonraker.conf
vi /mnt/UDISK/printer_data/config/moonraker-user.conf
RESTART
grep -n "EOL while scanning string literal" -n /tmp/klippy.log | tail -n 5
grep -n "Config error" -n /tmp/klippy.log | tail -n 20
grep -n "EOL while scanning string literal" -n /tmp/klippy.log | tail -n 5
grep -n "Config error" -n /tmp/klippy.log | tail -n 20
grep -n "EOL while scanning string literal" -n /tmp/klippy.log | tail -n 5
grep -n "Config error" -n /tmp/klippy.log | tail -n 20
grep -nP "[\x80-\xFF]" /mnt/UDISK/printer_data/config/macros_pure_klipper_k2.cfg | head -n 50
tail -n 50 /tmp/klippy.log
Config error in /mnt/UDISK/printer_data/config/macros_pure_klipper_k2.cfg
find /tmp /var /mnt -maxdepth 5 -type f -iname "*klippy*.log" 2>/dev/null
find /tmp /var /mnt -maxdepth 5 -type f -iname "*moonraker*.log" 2>/dev/null
ls -la /mnt/UDISK/printer_data/logs 2>/dev/null
ls -la /mnt/UDISK/printer_data 2>/dev/nullgrep -n "EOL while scanning string literal" /mnt/UDISK/printer_data/logs/klippy.log | tail -n 5
grep -n "Config error" /mnt/UDISK/printer_data/logs/klippy.log | tail -n 20
grep -n "Config error" /mnt/UDISK/printer_data/logs/klippy.log | tail -n 1
sed -n '81220,81260p' /mnt/UDISK/printer_data/logs/klippy.log
ls ... 2>/dev/nullgrep -n "EOL while..."
sed -n '81101,81240p' /mnt/UDISK/printer_data/logs/klippy.log
{% set hop = params.HOP|default(printer["gcode_macro _CLIENT"].park_z_lift)|float %}
vi /mnt/UDISK/printer_data/config/macro_pureklipperk2.cfg
mount | grep UDISK
/etc/init.d/klipper restart 2>/dev/null || service klipper restart 2>/dev/null
grep -n ":[0-9]\.[0-9]f" /mnt/UDISK/printer_data/config/macro_pureklipperk2.cfg
tail -n 80 /mnt/UDISK/printer_data/logs/klippy.log
grep -nE "include.*macros_pure_klipper_k2\.cfg|include.*gcode_macro\.cfg|include.*macros_pure\.cfg|include.*user_macros\.cfg" /mnt/UDISK/printer_data/config/printer.cfg
grep -nE "include.*macro_pureklipperk2\.cfg|include.*gcode_macro\.cfg|include.*macros_pure\.cfg|include.*user_macros\.cfg" /mnt/UDISK/printer_data/config/printer.cfg
ls -la /mnt/UDISK/printer_data/config/macros_pure_klipper_k2.cfg
ls -la /mnt/UDISK/printer_data/config/macro_pureklipperk2.cfg
grep -n "Reading config file" /mnt/UDISK/printer_data/logs/klippy.log | tail -n 30
ls
grep -n "Reading config file" /mnt/UDISK/printer_data/logs/klippy.log | tail -n 30
tail -n 80 /mnt/UDISK/printer_data/logs/klippy.log
ls -la /mnt/UDISK/printer_data/config | grep -i macro
grep -nE "^\[include " /mnt/UDISK/printer_data/config/printer.cfg
grep -n "Reading config file" /mnt/UDISK/printer_data/logs/klippy.log | tail -n 40
grep -n "Reading config file" /mnt/UDISK/printer_data/logs/klippy.log | tail -n 50
grep -n "Reading config file" /mnt/UDISK/printer_data/logs/klippy.log | tail -n 80
grep -nE "Config error|TemplateSyntaxError|Error loading template" /mnt/UDISK/printer_data/logs/klippy.log | tail -n 30
grep -n ":\.[0-9]f" /mnt/UDISK/printer_data/config/macro_pureklipperk2.cfg
tail -n 80 /mnt/UDISK/printer_data/logs/klippy.log
grep -Rni "auto_addr_wrapper\|485" /mnt/UDISK/printer_data/config
sed -n '1,160p' /mnt/UDISK/printer_data/config/box.cfg
grep -Rni "BOX_INFO_REFRESH" /mnt/UDISK/printer_data/config
grep -Rni "\[delayed_gcode" /mnt/UDISK/printer_data/config/box.cfg
grep -Rni "UPDATE_DELAYED_GCODE" /mnt/UDISK/printer_data/config/box.cfg
/etc/init.d/klipper restart
grep -n "Error loading template" /mnt/UDISK/printer_data/logs/klippy.log | tail -n 5
grep -n "TemplateSyntaxError\|EOL while scanning string literal" /mnt/UDISK/printer_data/logs/klippy.log | tail -n 20
sed -i '/{%-\? *return *-?%}/d' /mnt/UDISK/printer_data/config/box.cfg
/etc/init.d/klipper restart
grep -n "^\[gcode_macro BOX_INFO_REFRESH\]" /mnt/UDISK/printer_data/config/box.cfg
grep -Rni "{% *return *%}" /mnt/UDISK/printer_data/config
/etc/init.d/klipper restart
grep -n "Error loading template" /mnt/UDISK/printer_data/logs/klippy.log | tail -n 20
/etc/init.d/klipper stop
sleep 2
/etc/init.d/klipper start
tail -n 120 /mnt/UDISK/printer_data/logs/klippy.log
tail -n 80 /mnt/UDISK/printer_data/logs/klippy.log | grep -iE "disconnect|shutdown|mcu 'mcu' shutdown|error|traceback"
tail -n 120 /mnt/UDISK/printer_data/logs/moonraker.log
vi /mnt/UDISK/printer_data/config/box.cfg
/etc/init.d/klipper restart
/etc/init.d/moonraker restart
ls /etc/init.d | grep -iE "klipper|moonraker|mainsail|fluidd"
grep -n "^\[gcode_macro _BOX_OK\]" -n /mnt/UDISK/printer_data/config/box.cfg -A3
tail -f /mnt/UDISK/printer_data/logs/moonraker.log | grep -i "Klippy Connection"
tail -n 120 /mnt/UDISK/printer_data/logs/klippy.log | grep -iE "shutdown|error|traceback|timeout|disconnect|485|auto_addr" | tail -n 120
/etc/init.d/klipper restart
/etc/init.d/moonraker restart
tail -n 50 /mnt/UDISK/printer_data/logs/moonraker.log | grep -i 485
/etc/init.d/klipper restart
/etc/init.d/moonraker restart
grep -Rni "^\[box\]" /mnt/UDISK/printer_data/config
grep -nE "^\[include .*box.*\.cfg\]" /mnt/UDISK/printer_data/config/printer.cfg
/etc/init.d/klipper restart
/etc/init.d/moonraker restart
/etc/init.d/klipper restart
/etc/init.d/moonraker restart
/etc/init.d/klipper restart
/etc/init.d/moonraker restart
/etc/init.d/klipper restart
/etc/init.d/moonraker restart
/etc/init.d/klipper restart
/etc/init.d/moonraker restart
/etc/init.d/klipper restart
/etc/init.d/moonraker restart
/etc/init.d/klipper restart
/etc/init.d/moonraker restart
grep -n "Config error" /mnt/UDISK/printer_data/logs/klippy.log | tail -n 1
sed -n 'LINE,LINE+60p' /mnt/UDISK/printer_data/logs/klippy.log
sed -n '196750,196820p' /mnt/UDISK/printer_data/logs/klippy.log
awk '
/===== Config file =====/{in=1}
in && /^\[ERROR\]/{print NR; exit}
' /mnt/UDISK/printer_data/logs/klippy.log
sed -n 'LINE-40,LINE+80p' /mnt/UDISK/printer_data/logs/klippy.log
grep -Rni "^\[gcode_macro _IF_HOME_Z\]" /mnt/UDISK/printer_data/config
/etc/init.d/klipper restart
tail -n 80 /mnt/UDISK/printer_data/logs/klippy.log | grep -iE "Config error|TemplateSyntaxError|EOL while"
/etc/init.d/klipper restart
grep -n "Config error" /mnt/UDISK/printer_data/logs/klippy.log | tail -n 3
tail -n 120 /mnt/UDISK/printer_data/logs/klippy.log
sed -i 's/^\[auto_addr\]/# [auto_addr]/' /mnt/UDISK/printer_data/config/box.cfg
/etc/init.d/klipper restart
/etc/init.d/moonraker restart
tail -n 80 /mnt/UDISK/printer_data/logs/klippy.log | grep -iE "auto_addr_wrapper|485_send"
nl -ba /mnt/UDISK/printer_data/config/sensorless.cfg | sed -n '1,120p'
/etc/init.d/klipper restart
/etc/init.d/moonraker restart
grep -n "_IF_HOME_Z" /mnt/UDISK/printer_data/logs/klippy.log | tail -n 5
{% if printer['gcode_macro Qmode'].flag | int == 1 %}
SET_GCODE_VARIABLE MACRO=Qmode VARIABLE=fan0_value VALUE={printer["gcode_macro PRINTER_PARAM"].fan0_min + value}
...
{% endif %}
grep -RIn "scanning string literal\|jinja\|EOL while scanning" /etc/klipper/ /root/ 2>/dev/null
grep -n "EOL while scanning string literal" -n /tmp/klippy.log
ls -la /mnt/UDISK/printer_data/logs 2>/dev/null
grep -n "TemplateSyntaxError\|EOL while scanning string literal" /mnt/UDISK/printer_data/logs/klippy.log | tail -n 30
grep -RIn "^\[gcode_macro Qmode_exit\]" /mnt/UDISK/printer_data/config /etc/klipper 2>/dev/null
nl -ba /mnt/UDISK/printer_data/config/macros.cfg | sed -n '123,180p'
grep -RIn "^\[gcode_macro Qmode_exit\]" /mnt/UDISK/printer_data/config /etc/klipper 2>/dev/null
nl -ba /mnt/UDISK/printer_data/config/gcode_macro.cfg | sed -n '280,360p'
nl -ba /mnt/UDISK/printer_data/config/gcode_macro.cfg | sed -n '360,440p'
tail -n 30 /mnt/UDISK/printer_data/logs/klippy.log
cd ~/printer_data/config
grep -Rni "MOTOR_CHECK_PROTECTION_AFTER_HOME" .
grep -Rni "MOTOR_CHECK_PROTECTION_AFTER_HOME" ~/printer_data .
grep -Rni "MOTOR_CHECK_PROTECTION_AFTER_HOME" ~/klipper/klippy
grep -Rni "MOTOR_CHECK_PROTECTION_AFTER_HOME" /usr/share/klipper/klippy 2>/dev/null
grep -Rni "MOTOR_CHECK_PROTECTION_AFTER_HOME" /opt 2>/dev/null
grep -n "MOTOR_CHECK_PROTECTION_AFTER_HOME" -n ~/printer_data/logs/klippy.log | tail -n 20
tail -n 200 ~/printer_data/logs/klippy.log
find / -maxdepth 4 -type f -name "klippy.log" 2>/dev/null
find / -maxdepth 5 -type d -iname "*printer_data*" 2>/dev/null
find / -maxdepth 5 -type d -iname "*klipper*" 2>/dev/null
grep -n "MOTOR_CHECK_PROTECTION_AFTER_HOME" /path/to/klippy.log | tail -n 50
tail -n 200 /path/to/klippy.log
gcode.run_script_from_command("MOTOR_CHECK_PROTECTION_AFTER_HOME DATA=11")
cp /usr/share/klipper/klippy/extras/homing.py /usr/share/klipper/klippy/extras/homing.py.bak
sed -i 's/gcode.run_script_from_command("MOTOR_CHECK_PROTECTION_AFTER_HOME DATA=11")/# DISABLED: vendor motor check after home/g' /usr/share/klipper/klippy/extras/homing.py
/etc/init.d/klipper restart 2>/dev/null
/etc/init.d/klipper_service restart 2>/dev/null
/etc/init.d/mainsail restart 2>/dev/null
reboot
sed -n '60,95p' /usr/share/klipper/klippy/extras/homing.py
LOG="<LOG>"
grep -n "MOTOR_CHECK_PROTECTION_AFTER_HOME" "$LOG" | tail -n 50
tail -n 200 "$LOG"
logread | tail -n 300
logread | grep -n "klippy\|MOTOR_CHECK_PROTECTION_AFTER_HOME\|Traceback\|Internal error" | tail -n 200
find / -maxdepth 4 -type d -name "printer_data" 2>/dev/null
find / -type f -name "klippy.log" 2>/dev/null
LOG="<PASTE_REAL_KLIPPY_LOG_PATH_HERE>"
tail -n 250 "$LOG"
grep -n "ADJUST_STEPPERS\|MOTOR_CHECK_PROTECTION_AFTER_HOME\|Internal error\|Traceback\|Shutdown" "$LOG" | tail -n 200
find / -maxdepth 4 -type d -name "printer_data" 2>/dev/null
find / -type f -name "klippy.log" 2>/dev/null
grep -n "MOTOR_CHECK_PROTECTION_AFTER_HOME" /usr/share/klipper/klippy/extras/homing.py
grep -n "MOTOR_CHECK_PROTECTION_AFTER_HOME" /usr/share/klipper/klippy/extras/homing.py || echo "OK: none"
/etc/init.d/klipper restart
/etc/init.d/klipper_service restart
/etc/init.d/S55klipper restart
reboot
# once you find printer_data path, use it here:
PD="<PRINTER_DATA_PATH>"
grep -Rni "ADJUST_STEPPERS" "$PD"/config 2>/dev/null
grep -Rni "ADJUST_STEPPERS" "$PD" 2>/dev/null | head -n 50
find / -type f -name "klippy.log" 2>/dev/null
grep -n "MOTOR_CHECK_PROTECTION_AFTER_HOME" /usr/share/klipper/klippy/extras/homing.py
grep -Rni "ADJUST_STEPPERS" <printer_data_path>/config 2>/dev/null
grep -n "MOTOR_CHECK_PROTECTION_AFTER_HOME" /usr/share/klipper/klippy/extras/homing.py
find / -type f -name "klippy.log" 2>/dev/null
grep -Rni "ADJUST_STEPPERS" <printer_data_path>/config 2>/dev/null
LOG="/mnt/UDISK/printer_data/logs/klippy.log"
tail -n 250 "$LOG"
grep -n "ADJUST_STEPPERS\|MOTOR_CHECK_PROTECTION_AFTER_HOME\|Internal error\|Traceback\|Shutdown\|Unknown command" "$LOG" | tail -n 200
LOG="/mnt/UDISK/printer_data/logs/klippy.log"
tail -n 250 "$LOG"
cat /proc/partitions
ls -l /dev/mmc* /dev/mtd* 2>/dev/null
cat /proc/mtd
mount
mkdir -p /mnt/UDISK/fw_dump
cd /mnt/UDISK/fw_dump
dd if=/dev/root of=rom_squashfs.bin bs=4M status=progress
cd /mnt/UDISK/fw_dump
# 1) Dump the read-only squashfs firmware
dd if=/dev/root of=rom_squashfs.bin bs=4M
# 2) Dump the writable overlay partition
dd if=/dev/mmcblk0p10 of=overlay_ext4.bin bs=4M
trst
ls
kill -USR1 $(cat /tmp/ddpid)
which unsquashfs
unsquashfs -version 2>/dev/null || true
cd /mnt/UDISK/fw_dump
# 1) Dump the read-only squashfs firmware
dd if=/dev/root of=rom_squashfs.bin bs=4M
# 2) Dump the writable overlay partition
dd if=/dev/mmcblk0p10 of=overlay_ext4.bin bs=4M
cd /mnt/UDISK/fw_dump
ls -lh rom_squashfs.bin overlay_ext4.bin
# show magic / type hints
dd if=rom_squashfs.bin bs=4 count=1 2>/dev/null | hexdump -C
dd if=overlay_ext4.bin bs=2 count=1 2>/dev/null | hexdump -C
# if BusyBox has file(1), this is even nicer:
file rom_squashfs.bin overlay_ext4.bin 2>/dev/null || true
cd /mnt/UDISK/fw_dump
tar -czf klipper_usr_share.tgz /usr/share/klipper
tar -czf etc_configs.tgz /etc
tar -czf overlay_upper.tgz /overlay/upper
tar -czf printer_data.tgz /mnt/UDISK/printer_data
tar -czf klipper_usr_share.tgz /usr/share/klipper
cd /mnt/UDISK/fw_dump
# ext4 magic check (should print: 53 ef)
dd if=overlay_ext4.bin bs=1 skip=1080 count=2 2>/dev/null | hexdump -C
dd if=overlay_ext4.bin bs=1 skip=1024 count=128 2>/dev/null | hexdump -C | head
which file || echo "no file(1) installed"
cd /mnt/UDISK/fw_dump
tar -czf klipper_usr_share.tgz /usr/share/klipper
cd /mnt/UDISK/fw_dump
# OS + klipper + vendor python + services
tar -czf rom_usr_share_klipper.tgz /rom/usr/share/klipper
tar -czf etc_configs.tgz /etc
tar -czf overlay_upper.tgz /overlay/upper
tar -czf printer_data.tgz /mnt/UDISK/printer_data
tar -czf rom_etc.tgz /rom/etc
ls -lh *.tgz
tar -czf rom_usr_bin_sbin.tgz /rom/usr/bin /rom/usr/sbin 2>/dev/null
ls -lh rom_*.tgz
cd /mnt/UDISK/fw_dump
tar -czf rom_etc.tgz /rom/etc
tar -czf rom_usr_bin_sbin.tgz /rom/usr/bin /rom/usr/sbin 2>/dev/null
ls -lh rom_*.tgz
tar -czf overlay_upper.tgz /overlay/upper
ls -lh overlay_upper.tgz
tar -czf printer_data.tgz /mnt/UDISK/printer_data
ls -lh printer_data.tgz
LOG=/mnt/UDISK/printer_data/logs/klippy.log
grep -n "Unknown command:ADJUST_STEPPERS\|MOTOR_CHECK_PROTECTION_AFTER_HOME\|Internal error\|Traceback\|Shutdown" \
  "$LOG" | tail -n 250
sed -n '1,200p' /usr/share/moonraker/moonraker.conf
ps -ef | grep -i moonraker | grep -v grep
systemctl status moonraker 2>/dev/null
systemctl cat moonraker 2>/dev/null
grep -Rni "moonraker" /etc /usr/lib /usr/share 2>/dev/null | head -n 50
nano /overlay/upper/usr/share/moonraker/moonraker.conf
iv /overlay/upper/usr/share/moonraker/moonraker.conf
vi /overlay/upper/usr/share/moonraker/moonraker.conf
/etc/init.d/moonraker restart
# or
reboot
grep -n "enable_object_processing" /usr/share/moonraker/moonraker.conf
grep -n "queue_gcode_uploads"     /usr/share/moonraker/moonraker.conf
cp /mnt/UDISK/homing_patch_overlay.tgz /tmp/
cd /
tar -xzf /tmp/homing_patch_overlay.tgz -C /overlay/upper
sync
/etc/init.d/klipper restart 2>/dev/null || /etc/init.d/S55klipper restart 2>/dev/null || reboot
ls -l /overlay/upper/usr/share/klipper/klippy/extras/homing.py
grep -n "key22" /usr/share/klipper/klippy/extras/homing.py
ls -l /usr/share/klipper/klippy/extras/homing.py
ls -l /overlay/upper/usr/share/klipper/klippy/extras/homing.py
tail -n 80 /mnt/UDISK/printer_data/logs/klippy.log
tail -n 80 /mnt/UDISK/printer_data/logs/moonraker.log
python3 -m py_compile /usr/share/klipper/klippy/extras/homing.py
echo $?
grep -Rni "No active exception" /usr/share/klipper/klippy 2>/dev/null
grep -Rni "reraise" /usr/share/klipper/klippy 2>/dev/null
python3 -m py_compile /usr/share/klipper/klippy/extras/homing.py; echo "RC=$?"
tail -n 60 /mnt/UDISK/printer_data/logs/klippy.log
tail -n 60 /mnt/UDISK/printer_data/logs/moonraker.log
*
mount | grep -E "overlay|overlayfs"
ls -li /usr/share/klipper/klippy/extras/homing.py
ls -li /overlay/upper/usr/share/klipper/klippy/extras/homing.py
pid=$(pidof klippy.py 2>/dev/null || pgrep -f "klippy.py")
echo "PID=$pid"
ls -l /proc/$pid/fd 2>/dev/null | grep homing.py
strings /proc/$pid/maps | grep -m 5 -E "homing\.py|klippy/extras"
mount | grep -E "overlay|overlayfs"
pid=$(pgrep -f "klippy.py" | head -n1); echo PID=$pid; ls -l /proc/$pid/fd | grep homing.py
pid=$(pgrep -f "klippy.py" | head -n1)
tr '\0' '\n' < /proc/$pid/environ | grep -E 'PYTHONPATH|KLIPPER|VIRTUAL_ENV'
'
readlink -f /proc/$pid/cwd
readlink -f /proc/$pid/exe
tr '\0' '\n' < /proc/$pid/cmdline
python3 - <<'PY'
import sys, importlib
sys.path.insert(0, "/usr/share/klipper/klippy")
m = importlib.import_module("extras.homing")
print("extras.homing loaded from:", m.__file__)
PY
/etc/init.d/klipper stop 2>/dev/null || /etc/init.d/S55klipper stop 2>/dev/null
sleep 1
pkill -f klippy.py
sleep 1
/etc/init.d/klipper start 2>/dev/null || /etc/init.d/S55klipper start 2>/dev/null
readlink -f /usr/share/klipper/klippy/extras/homing.py
ls -ld /usr /usr/share /usr/share/klipper /usr/share/klipper/klippy
grep -n "handle_force_stop" -n /overlay/upper/usr/share/klipper/klippy/extras/homing.py | head
grep -n "Must NEVER crash klippy" /overlay/upper/usr/share/klipper/klippy/extras/homing.py
.
set -x
pid=$(pgrep -f "klippy\.py" | head -n1)
echo "PID=$pid"
echo "=== klippy cmdline ==="
tr '\0' ' ' < /proc/$pid/cmdline; echo
echo "=== klippy cwd ==="
readlink -f /proc/$pid/cwd || true
echo "=== overlay mount ==="
mount | grep -E 'overlayfs|/overlay' || true
echo "=== homing file resolution ==="
echo "lower view:"
ls -li /usr/share/klipper/klippy/extras/homing.py
echo "upper file:"
ls -li /overlay/upper/usr/share/klipper/klippy/extras/homing.py
echo "=== key strings in upper ==="
grep -n "Must NEVER crash klippy" /overlay/upper/usr/share/klipper/klippy/extras/homing.py || true
grep -n "handle_force_stop" /overlay/upper/usr/share/klipper/klippy/extras/homing.py | head -n 5 || true
echo "=== python import path test ==="
python3 - <<'PY'
import sys, importlib
sys.path.insert(0, "/usr/share/klipper/klippy")
m = importlib.import_module("extras.homing")
print("extras.homing loaded from:", m.__file__)
PY
mkdir -p /overlay/upper/usr/share/moonraker
cp /usr/share/moonraker/moonraker.conf \
   /overlay/upper/usr/share/moonraker/moonraker.conf
vi /overlay/upper/usr/share/moonraker/moonraker.conf
/etc/init.d/moonraker restart || reboot
grep -i include /mnt/UDISK/printer_data/logs/moonraker.log
/etc/init.d/klipper restart 2>/dev/null || /etc/init.d/S55klipper restart 2>/dev/null || reboot
grep -Rni "macro_pure_klipper_k2" /mnt/UDISK/printer_data/logs 2>/dev/null | head
ss -lntp | grep 7125
ss -lntp | grep 7125
ls -l /etc/nginx/conf.d
grep -Rni "listen" /etc/nginx/conf.d | head -n 50
sed -n '1,200p' /etc/nginx/conf.d/fluidd_port81.conf
cat >/etc/nginx/conf.d/ui2_port82.conf <<'EOF'
server {
    listen 82;
    # ----- UI2 static files -----
    root /usr/share/mainsail;   # <-- change this path to your UI folder
    index index.html;
    location / {
        try_files $uri $uri/ /index.html;
    }
    # ----- Moonraker HTTP API -----
    location /printer/ {
        proxy_pass http://127.0.0.1:7125;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    location /server/ {
        proxy_pass http://127.0.0.1:7125;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    location /machine/ {
        proxy_pass http://127.0.0.1:7125;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    location /access/ {
        proxy_pass http://127.0.0.1:7125;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    location /api/ {
        proxy_pass http://127.0.0.1:7125;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    # ----- Moonraker WebSocket -----
    location /websocket {
        proxy_pass http://127.0.0.1:7125/websocket;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }
}
EOF
ls -ld /usr/share/mainsail /www/mainsail /mnt/UDISK/printer_data/mainsail 2>/dev/null
cp -a /etc/nginx/conf.d/fluidd_port81.conf /etc/nginx/conf.d/ui2_port82.conf
sed -i 's/listen 81;/listen 82;/' /etc/nginx/conf.d/ui2_port82.conf
grep -n "listen" /etc/nginx/conf.d/ui2_port82.conf
grep -nE "root |alias " /etc/nginx/conf.d/fluidd_port81.conf
mkdir -p /mnt/UDISK/printer_data/www/ui2
root /mnt/UDISK/printer_data/www/ui2;
sed -i 's#root .*;#root /mnt/UDISK/printer_data/www/ui2;#' /etc/nginx/conf.d/ui2_port82.conf
grep -nE "root " /etc/nginx/conf.d/ui2_port82.conf
ls -la /mnt/UDISK/printer_data/www/ui2 | head
nginx -t && /etc/init.d/nginx restart
wget -qO- http://127.0.0.1:82 | head
cat /etc/nginx/conf.d/fluidd_port81.conf
ls -l /usr/share/mainsail/index.html
sed -i 's#root .*;#root /mnt/UDISK/printer_data/www/ui2;#' \
    /etc/nginx/conf.d/ui2_port82.conf
cd ~ && git clone https://github.com/dw-0/kiauh.git
nginx -t && /etc/init.d/nginx restart
ps | grep -E "nginx" | grep -v grep
netstat -lntp 2>/dev/null | grep -E ":81|:82|nginx"
# if netstat isn't available:
ss -lntp 2>/dev/null | grep -E ":81|:82"
# OpenWrt typical:
uci add firewall rule
uci set firewall.@rule[-1].name='Allow-UI2-82'
uci set firewall.@rule[-1].src='lan'
uci set firewall.@rule[-1].proto='tcp'
uci set firewall.@rule[-1].dest_port='82'
uci set firewall.@rule[-1].target='ACCEPT'
uci commit firewall
/etc/init.d/firewall restart
grep -n "include" /etc/nginx/nginx.conf
root@K2-86EE:~# grep -n "include" /etc/n
ginx/nginx.conf
8:    include       mime.types;
vi /etc/nginx/nginx.conf
nginx -t && /etc/init.d/nginx restart
chmod +x /usr/share/moonraker-bridge/moonraker_bridge.py
ls
python3 -c "import flask, requests; print('OK')"
python3 -m pip install flask requests
python3 -c "import flask, requests; print('OK')"
python3 -m pip install flask requests
python3 -m pip install --upgrade pip
python3 -m pip install flask requests
python3 -c "import flask, requests; print('OK')"
python3 /usr/share/moonraker-bridge/moonraker_bridge.py
/etc/init.d/klipper stop 2>/dev/null || /etc/init.d/S55klipper stop 2>/dev/null
pkill -f klippy.py 2>/dev/null
/etc/init.d/klipper stop 2>/dev/null || /etc/init.d/S55klipper stop 2>/dev/null
pkill -f klippy.py 2>/dev/null
# this only works if klippy is still responding; otherwise skip
printf "M84\n" > /tmp/printer 2>/dev/null || true
rm -f /overlay/upper/usr/share/klipper/klippy/extras/homing.py
sync
rmdir -p /overlay/upper/usr/share/klipper/klippy/extras 2>/dev/null || true
sync
/etc/init.d/klipper start 2>/dev/null || /etc/init.d/S55klipper start 2>/dev/null
ls -l /overlay/upper/usr/share/klipper/klippy/extras/homing.py
ls -l /usr/share/klipper/klippy/extras/homing.py
grep -n "Must NEVER crash klippy" -R /usr/share/klipper/klippy/extras/homing.py || echo "OK: patch marker not found"
mkdir -p /overlay/upper/usr/share/klipper/klippy/extras
cp /tmp/homing.py /overlay/upper/usr/share/klipper/klippy/extras/homing.py
sync
nano /usr/share/klipper/klippy/__init__.py
import sys
sys.path.insert(0, "/overlay/upper/usr/share/klipper/klippy")
nano /usr/share/klipper/klippy/__init__.py
la
ls
vi /usr/share/klipper/klippy/__init__.py
vi /overlay/upper/usr/share/klipper/klippy/extras/homing.py
python3 -m py_compile /overlay/upper/usr/share/klipper/klippy/extras/homing.py || echo FAIL
python3 - <<'PY'
import sys, importlib
sys.path.insert(0, "/overlay/upper/usr/share/klipper/klippy")
m = importlib.import_module("extras.homing")
print("LOADED FROM:", m.__file__)
PY
/etc/init.d/klipper stop 2>/dev/null || /etc/init.d/S55klipper stop
pkill -f klippy.py
sleep 1
/etc/init.d/klipper start 2>/dev/null || /etc/init.d/S55klipper start
python3 - <<'PY'
import sys, importlib
sys.path.insert(0, "/overlay/upper/usr/share/klipper/klippy")
m = importlib.import_module("extras.homing")
print("ACTIVE homing.py:", m.__file__)
PY
grep -R "SAFE_ABORT" /mnt/UDISK/printer_data/logs/ -n
pid=$(pgrep -f klippy.py)
strings /proc/$pid/maps | grep homing.py
pid=$(pgrep -f klippy.py)
strings /proc/$pid/maps | grep homing.py
python3 - <<'PY'
import sys, importlib
sys.path.insert(0, "/overlay/upper/usr/share/klipper/klippy")
m = importlib.import_module("extras.homing")
print("ACTIVE homing.py:", m.__file__)
PY
/vi /overlay/upper/usr/share/klipper/klippy/extras/homing.py
vi /overlay/upper/usr/share/klipper/klippy/extras/homing.py
python3 -m py_compile /overlay/upper/usr/share/klipper/klippy/extras/homing.py
echo $?
python3 -m py_compile /overlay/upper/usr/share/klipper/klippy/extras/homing.py
echo $?
pid=$(pgrep -f "klippy.py" | head -n1)
echo "PID=$pid"
tr '\0' '\n' < /proc/$pid/environ | grep -E 'PYTHONPATH|KLIPPER|VIRTUAL_ENV|HOME'
/python3 - <<'PY'
import sys, importlib
sys.path.insert(0, "/usr/share/klipper/klippy")
m = importlib.import_module("extras.homing")
print("extras.homing loaded from:", m.__file__)
PY
python3 - <<'PY'
import sys, importlib
sys.path.insert(0, "/usr/share/klipper/klippy")
m = importlib.import_module("extras.homing")
print("extras.homing loaded from:", m.__file__)
PY
python3 -m py_compile /overlay/upper/usr/share/klipper/klippy/extras/homing.py
echo $?
cp -a /usr/share/klipper/klippy/extras/homing.py /usr/share/klipper/klippy/extras/homing.py.bak.$(date +%Y%m%d-%H%M%S)
cp -a /overlay/upper/usr/share/klipper/klippy/extras/homing.py /usr/share/klipper/klippy/extras/homing.py
sync
/etc/init.d/klipper restart 2>/dev/null || /etc/init.d/S55klipper restart 2>/dev/null || reboot
python3 - <<'PY'
import sys, importlib
sys.path.insert(0, "/usr/share/klipper/klippy")
m = importlib.import_module("extras.homing")
print("extras.homing loaded from:", m.__file__)
PY
grep -n "handle_force_stop" /usr/share/klipper/klippy/extras/homing.py | head
# 1) Backup the currently-active file
cp -a /usr/share/klipper/klippy/extras/homing.py \
      /usr/share/klipper/klippy/extras/homing.py.bak.$(date +%Y%m%d-%H%M%S)
# 2) Replace it with your fixed overlay version
cp -a /overlay/upper/usr/share/klipper/klippy/extras/homing.py \
      /usr/share/klipper/klippy/extras/homing.py
sync
grep -n "handle_force_stop" /usr/share/klipper/klippy/extras/homing.py | head -n 10
grep -n "Must NEVER crash klippy" /usr/share/klipper/klippy/extras/homing.py
python3 -m py_compile /usr/share/klipper/klippy/extras/homing.py
echo $?
python3 -m py_compile /usr/share/klipper/klippy/extras/homing.py
echo $?
/etc/init.d/klipper restart 2>/dev/null || /etc/init.d/S55klipper restart 2>/dev/null || reboot
python3 - <<'PY'
import sys, importlib
sys.path.insert(0, "/usr/share/klipper/klippy")
m = importlib.import_module("extras.homing")
print("extras.homing loaded from:", m.__file__)
PY
python3 -m py_compile /usr/share/klipper/klippy/extras/homing.py
echo "RC=$?"
python3 - <<'PY'
import py_compile, traceback
try:
    py_compile.compile("/usr/share/klipper/klippy/extras/homing.py", doraise=True)
    print("OK")
except Exception:
    traceback.print_exc()
PY
||
nl -ba /usr/share/klipper/klippy/extras/homing.py | sed -n '60,120p'
nl -ba /usr/share/klipper/klippy/extras/homing.py | sed -n '120,180p'
ls -1 /usr/share/klipper/klippy/extras/homing.py.bak.* 2>/dev/null | tail -n 5
cp -a /usr/share/klipper/klippy/extras/homing.py.bak.YYYYMMDD-HHMMSS \
      /usr/share/klipper/klippy/extras/homing.py
sync
/etc/init.d/klipper restart 2>/dev/null || /etc/init.d/S55klipper restart 2>/dev/null || reboot
pidof klippy.py 2>/dev/null || pgrep -f klippy.py
logread | tail -n 80 | grep -i -E "klippy|homing|error|traceback"
pidof klippy.py 2>/dev/null || pgrep -f klippy.py
logread | tail -n 80 | grep -i -E "klippy|homing|error|traceback"
# 1) Confirm klippy stays up for a minute
pid=$(pidof klippy.py 2>/dev/null || pgrep -f klippy.py | head -n1)
echo "PID=$pid"
sleep 5
ps | grep -E "klippy.py" | grep -v grep
# 2) Check klippy log file (this is the real one, not logread)
ls -l /tmp/klippy.log 2>/dev/null
tail -n 80 /tmp/klippy.log 2>/dev/null | tail -n 40
find / -maxdepth 4 -type f -name "klippy.log" 2>/dev/null
dropbear -h 2>&1 | head -n 30
cat /etc/config/dropbear
LOG="/mnt/UDISK/printer_data/logs/klippy.log"
ls -lh "$LOG"
tail -n 120 "$LOG" | tail -n 80
LOG="/mnt/UDISK/printer_data/logs/klippy.log"
# show last modified time
ls -l "$LOG"
# force a restart, then check timestamp changes
/etc/init.d/klipper restart 2>/dev/null || /etc/init.d/S55klipper restart 2>/dev/null
sleep 2
ls -l "$LOG"
tail -n 60 "$LOG"
find /mnt -type f -name "klippy.log" 2>/dev/null
PYTHONDONTWRITEBYTECODE=1 python3 -m py_compile /usr/share/klipper/klippy/extras/homing.py
pid=$(pgrep -f "klippy.py" | head -n1)
echo "PID=$pid"
ls -l /proc/$pid/root/usr/share/klipper/klippy/extras/homing.py
ls -l /proc/$pid/root/overlay/upper/usr/share/klipper/klippy/extras/homing.py 2>/dev/null
sed -n '1,140p' /proc/$pid/root/usr/share/klipper/klippy/extras/homing.py | nl -ba | head -n 140
cp -a /usr/share/klipper/klippy/extras/homing.py \
      /usr/share/klipper/klippy/extras/homing.py.BAK.$(date +%F-%H%M%S)
cp -a /overlay/upper/usr/share/klipper/klippy/extras/homing.py \
      /usr/share/klipper/klippy/extras/homing.py
sync
/etc/init.d/klipper restart 2>/dev/null || /etc/init.d/S55klipper restart 2>/dev/null
python3 - <<'PY'
import sys, importlib
sys.path.insert(0, "/usr/share/klipper/klippy")
m = importlib.import_module("extras.homing")
print("extras.homing loaded from:", m.__file__)
print("has handle_force_stop:", hasattr(getattr(m, "HomingMove"), "handle_force_stop"))
PY
/cp -af /overlay/upper/usr/share/klipper/klippy/extras/homing.py \
      /usr/share/klipper/klippy/extras/homing.py
sync
/etc/init.d/klipper restart 2>/dev/null || /etc/init.d/S55klipper restart 2>/dev/null
cat /overlay/upper/usr/share/klipper/klippy/extras/homing.py > /usr/share/klipper/klippy/extras/homing.py
sync
pid=$(pgrep -f "klippy.py" | head -n1)
ls -l /proc/$pid/root/usr/share/klipper/klippy/extras/homing.py
|grep -n "shutdown sequence skipped" /proc/$pid/root/usr/share/klipper/klippy/extras/homing.py
grep -n "MOTOR_CHECK_PROTECTION_AFTER_HOME" /proc/$pid/root/usr/share/klipper/klippy/extras/homing.py
grep -n "shutdown sequence skipped" /proc/$pid/root/usr/share/klipper/klippy/extras/homing.py
grep -n "MOTOR_CHECK_PROTECTION_AFTER_HOME" /proc/$pid/root/usr/share/klipper/klippy/extras/homing.py
sed -n '60,120p' /proc/$pid/root/usr/share/klipper/klippy/extras/homing.py | awk '{printf "%5d  %s\n", NR+59, $0}'
gcode = self.printer.lookup_object('gcode')
try:
    gcode.run_script_from_command("MOTOR_STALL_MODE DATA=2")
except Exception as e:
    logging.warning(...)
gcode = self.printer.lookup_object('gcode')
try:
    gcode.run_script_from_command("MOTOR_STALL_MODE DATA=2")
except Exception as e:
    logging.warning(...)
/etc/init.d/klipper restart || /etc/init.d/S55klipper restart
G28 X
G28 Y
G28 Z
nginx -T 2>/dev/null | grep -nE "listen 81;|server_name|root |index |try_files"
grep -Rni "listen 81" /etc/nginx 2>/dev/null
ROOTPATH="/put/the/path/here"
ls -la "$ROOTPATH"
ls -la "$ROOTPATH/index.html"
ROOTPATH="/put/the/path/here"
chmod -R a+rX "$ROOTPATH"
find "$ROOTPATH" -type d -exec chmod 755 {} \;
find "$ROOTPATH" -type f -exec chmod 644 {} \;
nginx -t && /etc/init.d/nginx restart
logread | tail -n 80 | grep -i nginx
ls -la /var/log/nginx 2>/dev/null
tail -n 80 /var/log/nginx/error.log 2>/dev/null
tail -n 80 /tmp/nginx/error.log 2>/dev/null
cat >/etc/nginx/conf.d/ui1_port81.conf <<'EOF'
server {
    listen 81;
    root /usr/share/fluidd;
    index index.html;
    location / {
        try_files $uri $uri/ /index.html;
    }
    location /websocket {
        proxy_pass http://127.0.0.1:7125/websocket;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }
    location ~ ^/(printer|server|machine|access|api)/ {
        proxy_pass http://127.0.0.1:7125;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
EOF
nginx -t && /etc/init.d/nginx restart
ls -la /usr/share
ls -la /usr/share/fluidd /usr/share/mainsail 2>/dev/null
curl -s -X POST http://127.0.0.1:7125/printer/gcode/script \
  -H "Content-Type: application/json" \
  -d '{"script":"G28 X"}'
which wget
wget -qO- --header="Content-Type: application/json" --post-data='{"script":"G28 Y"}' http://127.0.0.1:7125/printer/gcode/script
wget -qO- --header="Content-Type: application/json" --post-data='{"script":"G28 Z"}' http://127.0.0.1:7125/printer/gcode/script
python3 - <<'PY'
import json, urllib.request
url = "http://127.0.0.1:7125/printer/gcode/script"
data = json.dumps({"script":"G28 X"}).encode()
req = urllib.request.Request(url, data=data, headers={"Content-Type":"application/json"})
print(urllib.request.urlopen(req, timeout=5).read().decode())
PY
python3 - <<'PY'
import urllib.request
print(urllib.request.urlopen("http://127.0.0.1:7125/printer/info", timeout=5).read().decode())
PY
netstat -lntp 2>/dev/null | grep -E "7125|80|81|4408|moon|nginx" || ss -lntp 2>/dev/null | grep -E "7125|80|81|4408|moon|nginx"
python3 - <<'PY'
import py_compile
py_compile.compile("/usr/share/klipper/klippy/extras/homing.py", doraise=True)
print("compile OK")
PY
sync
/etc/init.d/klipper restart 2>/dev/null || /etc/init.d/S55klipper restart 2>/dev/null
python3 - <<'PY'
import urllib.request
print(urllib.request.urlopen("http://127.0.0.1:7125/printer/info", timeout=5).read().decode())
PY
# remove any stale bytecode/cache
rm -f /usr/share/klipper/klippy/extras/homing.pyc*
rm -rf /usr/share/klipper/klippy/extras/__pycache__
# tell python to put cache in tmp instead of that overlay path
export PYTHONPYCACHEPREFIX=/tmp/pycache
mkdir -p /tmp/pycache
# test compile again (should stop trying to write into /usr/share)
python3 - <<'PY'
import py_compile
py_compile.compile("/usr/share/klipper/klippy/extras/homing.py", doraise=True)
print("compile OK")
PY
cat >/etc/profile.d/nopyc.sh <<'SH'
export PYTHONDONTWRITEBYTECODE=1
export PYTHONPYCACHEPREFIX=/tmp/pycache
SH
chmod +x /etc/profile.d/nopyc.sh
mkdir -p /tmp/pycache
python3 - <<'PY'
import os
print("PYTHONDONTWRITEBYTECODE=", os.environ.get("PYTHONDONTWRITEBYTECODE"))
print("PYTHONPYCACHEPREFIX=", os.environ.get("PYTHONPYCACHEPREFIX"))
PY
python3 - <<'PY'
import time, json, urllib.request
url="http://127.0.0.1:7125/printer/info"
for i in range(40):
    try:
        j=json.loads(urllib.request.urlopen(url, timeout=2).read().decode())["result"]
        print(i, "state=", j.get("state"), "|", j.get("state_message","")[:140])
        if j.get("state") == "ready":
            break
    except Exception as e:
        print(i, "error:", e)
    time.sleep(0.5)
PY
tail -n 160 /mnt/UDISK/printer_data/logs/klippy.log
python3 - <<'PY'
import json, urllib.request
url="http://127.0.0.1:7125/printer/gcode/script"
data=json.dumps({"script":"QUERY_ENDSTOPS"}).encode()
req=urllib.request.Request(url, data=data, headers={"Content-Type":"application/json"})
print(urllib.request.urlopen(req, timeout=5).read().decode())
PY
python3 - <<'PY'
import urllib.request, traceback
try:
    r = urllib.request.urlopen("http://127.0.0.1:81/", timeout=3)
    print("HTTP", r.status)
    print(r.read(200).decode(errors="ignore"))
except Exception:
    traceback.print_exc()
PY
logread | tail -n 200 | grep -i -E "nginx|error|stale|fluidd|open\(|stat\(|permission"
ls -la /var/log/nginx 2>/dev/null
tail -n 200 /var/log/nginx/error.log 2>/dev/null
tail -n 200 /var/log/nginx/error.log.1 2>/dev/null
ls -la /usr/share/fluidd
head -n 5 /usr/share/fluidd/index.html
sed -n '1,120p' /etc/nginx/conf.d/fluidd_port81.conf 2>/dev/null
sed -i 's|root /usr/share/fluidd;|root /mnt/UDISK/printer_data/www/ui2;|g' /etc/nginx/conf.d/fluidd_port81.conf
nginx -t && /etc/init.d/nginx restart 2>/dev/null || nginx -s reload
python3 - <<'PY'
import urllib.request
print("HTTP", urllib.request.urlopen("http://127.0.0.1:81/", timeout=3).status)
PY
mkdir -p /mnt/UDISK/printer_data/www/fluidd
cp -a /usr/share/fluidd/* /mnt/UDISK/printer_data/www/fluidd/
root /mnt/UDISK/printer_data/www/fluidd;
#
ls -ld /usr/share /usr/share/fluidd
nginx -T 2>/dev/null | awk '
  $1=="server" && $2=="{"{in=1; blk=""}
  in{blk=blk $0 "\n"}
  in && $1=="}"{in=0; if (blk ~ /listen 81;|listen 82;/) print "----\n" blk}
'
nginx -T 2>/dev/null | awk '
  $1=="server" && $2=="{"{in=1; blk=""}
  in{blk=blk $0 "\n"}
  in && $1=="}"{in=0; if (blk ~ /listen 81;|listen 82;/) print "----\n" blk}
'
grep -RniE 'listen 81;|listen 82;' /etc/nginx 2>/dev/null
python3 - <<'PY'
import urllib.request
for p in (81,82):
    u=f"http://127.0.0.1:{p}/"
    r=urllib.request.urlopen(u,timeout=3)
    print(p, "status", r.status, "len", r.headers.get("Content-Length"), "type", r.headers.get("Content-Type"))
PY
sed -n '1,220p' /etc/nginx/conf.d/fluidd_port81.conf 2>/dev/null
sed -n '1,220p' /etc/nginx/conf.d/*.conf 2>/dev/null | sed -n '1,260p'
mv /etc/nginx/conf.d/WHATEVER_BAD.conf /etc/nginx/conf.d/WHATEVER_BAD.conf.disabled
server {
    listen 82;
    server_name _;
    root /mnt/UDISK/printer_data/www/ui2;
    index index.html;
    location / { try_files $uri $uri/ /index.html; }
    location /printer/ { proxy_pass http://127.0.0.1:7125; proxy_http_version 1.1; proxy_set_header Host $host; }
    location /server/  { proxy_pass http://127.0.0.1:7125; proxy_http_version 1.1; proxy_set_header Host $host; }
    location /websocket {
        proxy_pass http://127.0.0.1:7125/websocket;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }
}
server {
    listen 82;
    server_name _;
    root /mnt/UDISK/printer_data/www/ui2;
    index index.html;
    location / { try_files $uri $uri/ /index.html; }
    location /printer/ { proxy_pass http://127.0.0.1:7125; proxy_http_version 1.1; proxy_set_header Host $host; }
    location /server/  { proxy_pass http://127.0.0.1:7125; proxy_http_version 1.1; proxy_set_header Host $host; }
    location /websocket {
        proxy_pass http://127.0.0.1:7125/websocket;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }
}
python3 - <<'PY'
import urllib.request, re
def sniff(port):
    u=f"http://127.0.0.1:{port}/"
    r=urllib.request.urlopen(u,timeout=3)
    body=r.read(40000).decode("utf-8","ignore")
    # crude fingerprints
    tag = "unknown"
    if "fluidd" in body.lower(): tag="fluidd"
    if "mainsail" in body.lower(): tag="mainsail"
    if "ui2" in body.lower(): tag="ui2/other"
    print(port, "status", r.status, "len~", len(body), "fingerprint:", tag)
for p in (81,82,83):
    sniff(p)
PY
ls -la /mnt/UDISK/printer_data/www/Fluidd/index.html
ls -la /mnt/UDISK/printer_data/www/Mainsail/index.html
md5sum /mnt/UDISK/printer_data/www/Fluidd/index.html /mnt/UDISK/printer_data/www/Mainsail/index.html
add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
add_header Pragma "no-cache" always;
add_header Expires "0" always;
nginx -t && /etc/init.d/nginx restart
md5sum /mnt/UDISK/printer_data/www/Fluidd/index.html /mnt/UDISK/printer_data/www/Mainsail/index.html
python3 - <<'PY'
import urllib.request
for p in (81,82,83):
    r=urllib.request.urlopen(f"http://127.0.0.1:{p}/",timeout=3)
    body=r.read(6000).decode("utf-8","ignore").lower()
    print(p, r.status, ("fluidd" in body), ("mainsail" in body))
PY
md5sum /mnt/UDISK/printer_data/www/Fluidd/index.html /mnt/UDISK/printer_data/www/Mainsail/index.html
python3 - <<'PY'
import urllib.request
for p in (81,82,83):
    r=urllib.request.urlopen(f"http://127.0.0.1:{p}/",timeout=3)
    body=r.read(6000).decode("utf-8","ignore").lower()
    print(p, r.status, ("fluidd" in body), ("mainsail" in body))
PY
python3 - <<'PY'
import urllib.request, urllib.error
u="http://127.0.0.1:83/"
opener=urllib.request.build_opener(urllib.request.HTTPRedirectHandler())
r=opener.open(u,timeout=3)
print("final_url:", r.geturl())
print("status:", r.status)
print("server:", r.headers.get("Server"))
print("len:", r.headers.get("Content-Length"))
PY
nginx -T 2>/dev/null | grep -n "listen 83;" -n -B2 -A8
grep -Rni "listen 83" /etc/nginx 2>/dev/null
python3 - <<'PY'
import urllib.request, urllib.error
u="http://127.0.0.1:83/"
opener=urllib.request.build_opener(urllib.request.HTTPRedirectHandler())
r=opener.open(u,timeout=3)
print("final_url:", r.geturl())
print("status:", r.status)
print("server:", r.headers.get("Server"))
print("len:", r.headers.get("Content-Length"))
PY
nginx -T 2>/dev/null | grep -n "listen 83;" -n -B2 -A8
grep -Rni "listen 83" /etc/nginx 2>/dev/null
nginx -t && /etc/init.d/nginx restart
mv /etc/nginx/conf.d/<wrong>.conf /etc/nginx/conf.d/<wrong>.conf.off
nginx -t && /etc/init.d/nginx restart
ls -la /mnt/UDISK/printer_data/www/ui2/index.html
md5sum \
  /mnt/UDISK/printer_data/www/ui2/index.html \
  /mnt/UDISK/printer_data/www/Mainsail/index.html
echo "== ui2 =="; head -n 20 /mnt/UDISK/printer_data/www/ui2/index.html
echo "== mainsail =="; head -n 20 /mnt/UDISK/printer_data/www/Mainsail/index.html
grep -iE "mainsail|fluidd|manifest|serviceworker|workbox|sw\.js" -n \
  /mnt/UDISK/printer_data/www/ui2/index.html | head
root /mnt/UDISK/printer_data/www/ui2;
root /mnt/UDISK/printer_data/www/UI2;
nginx -t && /etc/init.d/nginx restart 2>/dev/null || /etc/init.d/S80nginx restart 2>/dev/null
python3 - <<'PY'
import urllib.request
r=urllib.request.urlopen("http://127.0.0.1:83/",timeout=3)
body=r.read(4000).decode("utf-8","ignore").lower()
print("status", r.status)
print("looks_like_mainsail:", "mainsail" in body)
print("looks_like_fluidd:", "fluidd" in body)
PY
md5sum \
/mnt/UDISK/printer_data/www/Fluidd/index.html \
/mnt/UDISK/printer_data/www/Mainsail/index.html \
/mnt/UDISK/printer_data/www/ui2/index.html
python3 - <<'PY'
import urllib.request
for p in (81,82,83):
    r=urllib.request.urlopen(f"http://127.0.0.1:{p}/",timeout=3)
    body=r.read(6000).decode("utf-8","ignore").lower()
    print(
        f"port {p}:",
        "fluidd" if "fluidd" in body else "",
        "mainsail" if "mainsail" in body else "",
        "custom" if ("debug" in body or "ui2" in body) else ""
    )
PY
nginx -t && /etc/init.d/nginx restart 2>/dev/null || /etc/init.d/S80nginx restart 2>/dev/null
python3 - <<'PY'
import urllib.request
for p in (81,82,83):
    r=urllib.request.urlopen(f"http://127.0.0.1:{p}/",timeout=3)
    body=r.read(6000).decode("utf-8","ignore").lower()
    print(
        f"port {p}:",
        "fluidd" if "fluidd" in body else "",
        "mainsail" if "mainsail" in body else "",
        "custom" if ("debug" in body or "ui2" in body) else ""
    )
PY
# wipe ui2 clean
rm -rf /mnt/UDISK/printer_data/www/ui2/*
sync
# quick minimal custom ui2 page (so you can instantly verify)
cat > /mnt/UDISK/printer_data/www/ui2/index.html <<'HTML'
<!doctype html>
<html>
<head><meta charset="utf-8"><title>UI2</title></head>
<body style="font-family:sans-serif">
<h1>UI2 (Port 83)</h1>
<p>If you see this, ui2 is NOT Fluidd/Mainsail.</p>
<ul>
  <li><a href="/printer/info">Moonraker /printer/info</a></li>
  <li><a href="/server/info">Moonraker /server/info</a></li>
</ul>
</body>
</html>
HTML
sync
/etc/init.d/nginx restart 2>/dev/null || /etc/init.d/S80nginx restart 2>/dev/null
md5sum /mnt/UDISK/printer_data/www/ui2/index.html
python3 - <<'PY'
import urllib.request
r=urllib.request.urlopen("http://127.0.0.1:83/",timeout=3)
b=r.read(3000).decode("utf-8","ignore").lower()
print("status", r.status, "fluidd" in b, "mainsail" in b, "ui2" in b)
PY
# wipe fluidd clean
rm -rf /mnt/UDISK/printer_data/www/Fluidd/*
sync
# quick minimal custom ui2 page (so you can instantly verify)
cat > /mnt/UDISK/printer_data/www/Fluidd/index.html <<'HTML'
<!doctype html>
<html>
<head><meta charset="utf-8"><title>Fluidd</title></head>
<body style="font-family:sans-serif">
<h1>Fluidd (Port 81)</h1>
<p>If you see this, Fluidd is NOT Fluidd/Mainsail.</p>
<ul>
  <li><a href="/printer/info">Moonraker /printer/info</a></li>
  <li><a href="/server/info">Moonraker /server/info</a></li>
</ul>
</body>
</html>
HTML
sync
/etc/init.d/nginx restart 2>/dev/null || /etc/init.d/S80nginx restart 2>/dev/null
md5sum /mnt/UDISK/printer_data/www/Fluidd/index.html
python3 - <<'PY'
import urllib.request
r=urllib.request.urlopen("http://127.0.0.1:81/",timeout=3)
b=r.read(3000).decode("utf-8","ignore").lower()
print("status", r.status, "fluidd" in b, "mainsail" in b, "ui2" in b)
PY
# wipe fluidd clean
rm -rf /mnt/UDISK/printer_data/www/Mainsail/*
sync
# quick minimal custom ui2 page (so you can instantly verify)
cat > /mnt/UDISK/printer_data/www/Mainsail/index.html <<'HTML'
<!doctype html>
<html>
<head><meta charset="utf-8"><title>Mainsail</title></head>
<body style="font-family:sans-serif">
<h1>Mainsail (Port 82)</h1>
<p>If you see this, Fluidd is NOT Fluidd/Mainsail.</p>
<ul>
  <li><a href="/printer/info">Moonraker /printer/info</a></li>
  <li><a href="/server/info">Moonraker /server/info</a></li>
</ul>
</body>
</html>
HTML
sync
/etc/init.d/nginx restart 2>/dev/null || /etc/init.d/S80nginx restart 2>/dev/null
md5sum /mnt/UDISK/printer_data/www/Mainsail/index.html
python3 - <<'PY'
import urllib.request
r=urllib.request.urlopen("http://127.0.0.1:82/",timeout=3)
b=r.read(3000).decode("utf-8","ignore").lower()
print("status", r.status, "fluidd" in b, "mainsail" in b, "ui2" in b)
PY
mkdir -p /mnt/UDISK/fw_backup_$(date +%F)
cd /mnt/UDISK/fw_backup_$(date +%F)
pwd
tar -czf rom_root.tgz /rom
ls
python3 /mnt/UDISK/fw_dump_backup.py
