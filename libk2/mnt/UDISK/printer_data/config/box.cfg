############################################################
# box.cfg â€” RS485 BOX support (single BOX_INFO_REFRESH)
# K2 Combo safe gating to avoid lockups when RS485 box is absent
############################################################

[serial_485 serial485]
serial: /dev/ttyS5
baud: 230400

# ----------------------------
# RS485 BOX: enable/disable gate
# ----------------------------

[gcode_macro _BOX_OK]
variable_enabled: 0
gcode:
  ; settings-only helper

[gcode_macro BOX_DISABLE]
description: Disable RS485 box operations (no polling / refresh)
gcode:
  SET_GCODE_VARIABLE MACRO=_BOX_OK VARIABLE=enabled VALUE=0
  {action_respond_info("RS485 BOX disabled (no polling)")}

[gcode_macro BOX_ENABLE]
description: Enable RS485 box operations
gcode:
  SET_GCODE_VARIABLE MACRO=_BOX_OK VARIABLE=enabled VALUE=1
  {action_respond_info("RS485 BOX enabled")}

# ----------------------------
# SAFE BOX_INFO_REFRESH (SINGLE definition!)
# ----------------------------

[gcode_macro BOX_INFO_REFRESH]
description: Refresh box info via RS485 (guarded)
gcode:
  {% if printer["gcode_macro _BOX_OK"].enabled|int == 1 %}
    {% if params.ADDR is defined and params.NUM is defined %}
      BOX_SET_PRE_LOADING ADDR={params.ADDR} NUM={params.NUM} ACTION=RUN
      M400
      BOX_GET_RFID ADDR={params.ADDR} NUM={params.NUM}
      M400
      BOX_GET_REMAIN_LEN ADDR={params.ADDR} NUM={params.NUM}
      M400
    {% else %}
      {action_respond_info("BOX_INFO_REFRESH requires ADDR and NUM")}
    {% endif %}
  {% else %}
    {action_respond_info("BOX_INFO_REFRESH skipped (RS485 disabled)")}
  {% endif %}

# [auto_addr]

[filament_rack]
not_pin: !PA5

[box]
bus: serial485
filament_sensor: filament_sensor

pre_cut_pos_x: 10
pre_cut_pos_y: 150
cut_pos_y: 150

Tn_retrude: -10
Tn_retrude_velocity: 600
Tn_extrude_temp: 220
Tn_extrude: 140
Tn_extrude_velocity: 360

buffer_empty_len: 30

clean_left_pos_x: 127
clean_left_pos_y: 291.5
clean_right_pos_x: 137
clean_right_pos_y: 291.5
clean_velocity: 12000

box_need_clean_length: 70
cut_velocity: 30000

extrude_pos_x: 115
extrude_pos_y: 291.5
has_extrude_pos: 1

safe_pos_y: 261
safe_pos_x: 205

clean_pos_left_x: 145
clean_pos_right_x: 155
clean_pos_middle_y: 291.5

pre_cut_cal_pos_x: -5
check_cut_pos_x_max: -5.5
check_cut_pos_x_min: -9.5

switch_pin: !nozzle_mcu:PB9
version: 1

[load_ai]

[gcode_macro BOX_CHECK_MATERIAL]
gcode:
  ; (left empty in your original)

[gcode_macro BOX_LOAD_MATERIAL_WITH_MATERIAL]
gcode:
  BOX_CHECK_MATERIAL
  BOX_CUT_MATERIAL
  BOX_SAVE_FAN
  BOX_RETRUDE_MATERIAL_WITH_TNN # BOX_RETRUDE_MATERIAL
  BOX_EXTRUDE_MATERIAL
  BOX_EXTRUDER_EXTRUDE
  BOX_MATERIAL_CHANGE_FLUSH # BOX_MATERIAL_FLUSH
  BOX_RESTORE_FAN
  BOX_MOVE_TO_SAFE_POS

[gcode_macro BOX_LOAD_MATERIAL_WITHOUT_MATERIAL]
gcode:
  M104
  BOX_CHECK_MATERIAL
  BOX_EXTRUDE_MATERIAL
  BOX_EXTRUDER_EXTRUDE
  BOX_MATERIAL_CHANGE_FLUSH # BOX_MATERIAL_FLUSH

[gcode_macro BOX_RETRUDE_MATERIAL_WITH_TNN]
rename_existing: BOX_RETRUDE_MATERIAL_WITH_TNN1
gcode:
  BOX_SET_TEMP
  BOX_GO_TO_EXTRUDE_POS
  BOX_RETRUDE_MATERIAL

[gcode_macro BOX_QUIT_MATERIAL]
gcode:
  BOX_CHECK_MATERIAL
  BOX_CUT_MATERIAL
  BOX_RETRUDE_MATERIAL_WITH_TNN
  BOX_MOVE_TO_SAFE_POS

############################################################
# END box.cfg
############################################################