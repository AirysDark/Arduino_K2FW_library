# ============================================================
# PURE KLIPPER MACRO PACK (K2-safe: no STATUS / no RESPOND)
# homing, leveling/mesh, park, pause/resume, cancel
# ============================================================

# Required for PAUSE/RESUME base behavior
[pause_resume]

# Optional (recommended): enables SET_GCODE_OFFSET, etc. if not already
# [gcode_arcs]  # leave commented unless you use arcs

# ------------------------------------------------------------
# USER TUNABLES (edit these to match your machine)
# ------------------------------------------------------------
[gcode_macro _CLIENT]
description: User-tunable variables for park/prime behavior
variable_park_x: 10.0
variable_park_y: 10.0
variable_park_z_lift: 10.0
variable_safe_z: 10.0
variable_prime_len: 18.0
variable_prime_speed: 6.0       # mm/s
variable_retract_len: 1.0
variable_retract_speed: 25.0    # mm/s
variable_unretract_speed: 25.0  # mm/s
variable_travel_speed: 200.0    # mm/s
variable_z_hop_speed: 15.0      # mm/s
gcode:
  ; no-op holder

# ------------------------------------------------------------
# INTERNAL HELPERS
# ------------------------------------------------------------
[gcode_macro _MSG]
description: Safe message helper (uses M117 only)
gcode:
  {% set t = params.T|default("") %}
  M117 {t}

[gcode_macro _SAFE_Z_HOP]
description: Lift Z safely if homed and able
gcode:
  {% set hop = params.HOP|default(printer["gcode_macro _CLIENT"].park_z_lift)|float %}
  {% set zspd = printer["gcode_macro _CLIENT"].z_hop_speed|float %}
  {% if "z" in printer.toolhead.homed_axes %}
    G91
    G1 Z{hop:.3f} F{(zspd*60)|int}
    G90
  {% endif %}

[gcode_macro _PARK]
description: Park toolhead safely (does not require extruder)
gcode:
  {% set cx = printer["gcode_macro _CLIENT"].park_x|float %}
  {% set cy = printer["gcode_macro _CLIENT"].park_y|float %}
  {% set tspd = printer["gcode_macro _CLIENT"].travel_speed|float %}
  {% set zhop = printer["gcode_macro _CLIENT"].park_z_lift|float %}
  _MSG T="Parking..."
  {% if printer.toolhead.homed_axes|length < 2 %}
    ; If not homed enough, just do nothing
    _MSG T="Not homed; skip park"
  {% else %}
    _SAFE_Z_HOP HOP={zhop}
    G90
    G1 X{cx:.2f} Y{cy:.2f} F{(tspd*60)|int}
  {% endif %}

[gcode_macro _RETRACT]
description: Safe retract if hot enough
gcode:
  {% set rlen = printer["gcode_macro _CLIENT"].retract_len|float %}
  {% set rspd = printer["gcode_macro _CLIENT"].retract_speed|float %}
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G91
    G1 E-{rlen:.3f} F{(rspd*60)|int}
    G90
  {% endif %}

[gcode_macro _UNRETRACT]
description: Safe unretract if hot enough
gcode:
  {% set rlen = printer["gcode_macro _CLIENT"].retract_len|float %}
  {% set usp  = printer["gcode_macro _CLIENT"].unretract_speed|float %}
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G91
    G1 E{rlen:.3f} F{(usp*60)|int}
    G90
  {% endif %}

[gcode_macro _PRIME_LINE]
description: Simple prime line near front-left (edit to suit)
gcode:
  {% set tspd = printer["gcode_macro _CLIENT"].travel_speed|float %}
  {% set plen = printer["gcode_macro _CLIENT"].prime_len|float %}
  {% set ps   = printer["gcode_macro _CLIENT"].prime_speed|float %}
  _MSG T="Priming..."
  G90
  ; Move to a safe spot (adjust if your bed origin differs)
  G1 X5 Y5 F{(tspd*60)|int}
  G1 Z0.30 F{(15*60)|int}
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G91
    G1 E{plen:.3f} F{(ps*60)|int}
    G90
  {% endif %}
  ; small wipe
  G1 X60 F{(tspd*60)|int}

# ------------------------------------------------------------
# HOMING (safe + predictable)
# ------------------------------------------------------------
[gcode_macro HOME_SAFE]
description: Home in a controlled order with a small Z lift
gcode:
  _MSG T="Homing..."
  ; Always try to lift first if Z is homed
  _SAFE_Z_HOP HOP={printer["gcode_macro _CLIENT"].safe_z|float}
  ; Home XY first (common safer pattern)
  G28 X Y
  ; Then Z
  G28 Z
  _MSG T="Homed"

# Optional: If you WANT G28 to always behave like HOME_SAFE,
# uncomment this rename + override.
# [gcode_macro G28]
# rename_existing: G28.1
# gcode:
#   HOME_SAFE

# ------------------------------------------------------------
# LEVELING / MESH
# ------------------------------------------------------------
[gcode_macro LEVEL_GANTRY_SAFE]
description: Runs gantry leveling (if configured) in a safe flow
gcode:
  _MSG T="Level gantry..."
  ; Ensure homed
  {% if printer.toolhead.homed_axes != "xyz" %}
    HOME_SAFE
  {% endif %}

  ; Try common leveling systems if present:
  {% if printer.configfile.settings.quad_gantry_level is defined %}
    QUAD_GANTRY_LEVEL
    G28 Z
    _MSG T="QGL done"
  {% elif printer.configfile.settings.z_tilt is defined %}
    Z_TILT_ADJUST
    G28 Z
    _MSG T="Z tilt done"
  {% else %}
    _MSG T="No QGL/Z_TILT configured"
  {% endif %}

[gcode_macro MESH_CAL]
description: Build/refresh bed mesh safely (loads after)
gcode:
  _MSG T="Mesh calibrate..."
  {% if printer.toolhead.homed_axes != "xyz" %}
    HOME_SAFE
  {% endif %}
  ; If you use gantry leveling, do it first
  LEVEL_GANTRY_SAFE

  ; Calibrate mesh
  BED_MESH_CLEAR
  BED_MESH_CALIBRATE
  BED_MESH_PROFILE SAVE=default
  BED_MESH_PROFILE LOAD=default
  _MSG T="Mesh saved"

[gcode_macro MESH_LOAD]
description: Load default mesh (if exists)
gcode:
  BED_MESH_PROFILE LOAD=default
  _MSG T="Mesh loaded"

# ------------------------------------------------------------
# PARK / PAUSE / RESUME / CANCEL
# ------------------------------------------------------------
[gcode_macro PARK]
description: Park toolhead (safe lift + move)
gcode:
  SAVE_GCODE_STATE NAME=PARK_STATE
  _PARK
  RESTORE_GCODE_STATE NAME=PARK_STATE

[gcode_macro PAUSE]
rename_existing: PAUSE_BASE
description: Pause print safely: retract, lift, park
gcode:
  SAVE_GCODE_STATE NAME=PAUSE_STATE
  _MSG T="Pausing..."
  _RETRACT
  _SAFE_Z_HOP HOP={printer["gcode_macro _CLIENT"].park_z_lift|float}
  _PARK
  PAUSE_BASE
  _MSG T="Paused"

[gcode_macro RESUME]
rename_existing: RESUME_BASE
description: Resume print safely: unretract then resume
gcode:
  _MSG T="Resuming..."
  _UNRETRACT
  RESTORE_GCODE_STATE NAME=PAUSE_STATE MOVE=1 MOVE_SPEED={printer["gcode_macro _CLIENT"].travel_speed|float}
  RESUME_BASE
  _MSG T="Printing"

[gcode_macro CANCEL_PRINT]
rename_existing: CANCEL_PRINT_BASE
description: Cancel print safely: retract, park, heaters off
gcode:
  _MSG T="Canceling..."
  _RETRACT
  _SAFE_Z_HOP HOP={printer["gcode_macro _CLIENT"].park_z_lift|float}
  _PARK
  TURN_OFF_HEATERS
  M107
  CANCEL_PRINT_BASE
  _MSG T="Canceled"

# ------------------------------------------------------------
# START / END PRINT (simple, slicer-friendly)
# ------------------------------------------------------------
[gcode_macro START_PRINT]
description: Slicer start macro - set temps, home, level, mesh, prime
gcode:
  {% set bed = params.BED|default(0)|float %}
  {% set hotend = params.HOTEND|default(0)|float %}

  _MSG T="Start print"

  ; Heat bed first (faster stability)
  {% if bed > 0 %}
    M140 S{bed}
    M190 S{bed}
  {% endif %}

  ; Heat hotend
  {% if hotend > 0 %}
    M104 S{hotend}
    M109 S{hotend}
  {% endif %}

  ; Prep motion
  HOME_SAFE

  ; Optional: gantry leveling + mesh load
  LEVEL_GANTRY_SAFE
  MESH_LOAD

  ; Prime
  _PRIME_LINE

  _MSG T="Ready"

[gcode_macro END_PRINT]
description: Slicer end macro - retract, park, cool down
gcode:
  _MSG T="End print"
  _RETRACT
  _SAFE_Z_HOP HOP={printer["gcode_macro _CLIENT"].park_z_lift|float}
  _PARK
  M107
  TURN_OFF_HEATERS
  _MSG T="Done"